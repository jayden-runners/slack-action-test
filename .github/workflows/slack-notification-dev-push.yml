name: Slack Notification for dev branch push

on:
  push:
    branches:
      - dev

jobs:
  send-slack-notification:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set push information
        id: set_push_info
        run: |
          echo "PUSH_AUTHOR=${{ github.actor }}" >> $GITHUB_ENV
          
          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì²« ë²ˆì§¸ ì¤„ë§Œ ì¶”ì¶œ
          FIRST_LINE=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          
          # PR ë¨¸ì§€ì¸ ê²½ìš° PR ë²ˆí˜¸ë¥¼ ì¶”ì¶œí•˜ì—¬ PR í˜ì´ì§€ë¡œ ì´ë™
          if [[ "${FIRST_LINE}" == "Merge pull request"* ]]; then
            PR_NUMBER=$(echo "${FIRST_LINE}" | grep -oP '#\K\d+')
            echo "CHANGE_URL=https://github.com/${{ github.repository }}/pull/${PR_NUMBER}" >> $GITHUB_ENV
            PR_TITLE=$(echo "${FIRST_LINE}" | grep -oP '(?<=Merge pull request #\d+ from \S+\s).*')
            echo "COMMIT_MSG=${PR_TITLE}" >> $GITHUB_ENV
          else
            echo "CHANGE_URL=https://github.com/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_ENV
            echo "COMMIT_MSG=${FIRST_LINE}" >> $GITHUB_ENV
          fi

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        with:
          channel-id: ${{ secrets.SLACK_DEPLOY_CHANNEL_ID }}
          payload: |
            {
              "text": "ğŸ”„ dev ë¸Œëœì¹˜ê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ”„ dev ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸ ì•Œë¦¼",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ë‹´ë‹¹ì:* ğŸ‘©â€ğŸ’» ${{ env.PUSH_AUTHOR }}\n*ì œëª©:* ${{ env.COMMIT_MSG }}\n\n dev ë¸Œëœì¹˜ê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ì—… ì „ ë°˜ë“œì‹œ pull/merge í•´ì£¼ì„¸ìš”!"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "emoji": true,
                        "text": "ğŸ” ë³€ê²½ì‚¬í•­ ë³´ê¸°"
                      },
                      "style": "primary",
                      "url": "${{ env.CHANGE_URL }}",
                      "value": "view_pr"
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ]
            }